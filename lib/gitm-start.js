#!/usr/bin/env node
"use strict";const{program:e}=require("commander"),t=require("shelljs"),{options:i,args:r}=require("./conf/start"),{error:s,success:g,queue:o,getStatus:c,isGitProject:u}=require("./js/index"),{createArgs:a}=require("./js/tools");u()||(t.echo(s("当前目录不是git项目目录")),t.exit(1));const n=require("./js/getConfig")();e.name("gitm start").usage("<type> <name>").description("创建bugfix任务分支、创建feature功能开发分支、support框架支持分支"),r.length>0&&e.arguments(a(r)),i.forEach((t=>{e.option(t.flags,t.description,t.defaultValue)})),e.action(((e,i,r)=>{const u=["bugfix","feature","support"];if(c()||t.exit(1),u.includes(e)){r.tag&&"bugfix"!==e&&(t.echo(s("指定从tag拉取分支时仅支持创建bugfix分支")),t.exit(1));const c=r.tag?r.tag:"bugfix"===e?n.bugfix:"support"===e?n.master:n.release,u=r.tag?["git fetch",`git checkout -b ${e}/${i} ${c}`]:["git fetch",`git checkout ${c}`,"git pull",`git checkout -b ${e}/${i} ${c}`];o(u).then((r=>{0===r[3].code&&t.echo(`${i}分支创建成功，该分支基于${c}创建，您当前已经切换到${e}/${i}\n如果需要提测，请执行${g("gitm combine "+e+" "+i)}\n开发完成后，记得执行: ${g("gitm end "+e+" "+i)}`)}))}else t.echo(s("type只允许输入："+JSON.stringify(u))),t.exit(1)})),e.parse(process.argv);

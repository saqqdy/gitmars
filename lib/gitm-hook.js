#!/usr/bin/env node
"use strict";const{program:e}=require("commander"),o=require("shelljs"),{options:s,args:r}=require("./conf/hook"),{error:n,success:i,getCurrent:t,getBranchsFromID:c,isGitProject:l}=require("./js/index"),{createArgs:a}=require("./js/tools"),u=require("./js/branch/getIsMergedDevBranch"),g=require("./js/branch/getIsUpdatedInTime"),p=require("./js/branch/getIsMergeAction"),d=require("./js/branch/getBehindLogs"),{init:h,remove:f}=require("./js/hook/index");l()||(o.echo(n("当前目录不是git项目目录")),o.exit(1));const v=require("./js/getConfig")();e.name("gitm hook").usage("[command]").description("git hook钩子"),r.length>0&&e.arguments(a(r)),s.forEach((o=>{e.option(o.flags,o.description,o.defaultValue)})),e.action(((e,s,r)=>{return l=void 0,a=null,m=function*(){if(console.log("gitmars hooks is running"),r.noVerify)o.exit(0);else{if("init"===e)h();else if("remove"===e)f();else{const e=r.type?r.type.split(","):[],s=[v.master,v.develop,v.release,v.support,v.bugfix],l=t();if(console.log(e,process.env,process.argv,c("2080d17e")),l!==v.develop&&s.includes(l)&&e.includes("1")){const[e,s]=process.env.GIT_REFLOG_ACTION?process.env.GIT_REFLOG_ACTION.split(" "):[];"merge"===e&&(u(s,v.develop)?console.info(i(s+"合并过"+v.develop)):(console.info(n("检测到你的分支没有合并过"+v.develop)),o.exit(0)))}if(s.includes(l)&&e.includes("2")){const[e,s]=process.env.GIT_REFLOG_ACTION?process.env.GIT_REFLOG_ACTION.split(" "):[],t=s.split("/")[0];"merge"===e&&(g({lastet:r.lastet,branch:s})?console.info(i(s+"一周内同步过主干分支代码")):(console.info(n("检测到你1周内没有同步过主干"+t+"分支代码")),o.exit(0)))}s.includes(l)&&e.includes("3")&&(p()?console.info(i("最后一条记录是merge记录")):(console.info(n("检测到你直接在主干分支修改代码")),o.exit(0))),s.includes(l)&&e.includes("4")&&(d().length?console.info(i("本地版本没有落后远程，可直接push")):(console.info("你本地分支版本落后于远程分支，请先执行pull"),o.exit(0)))}o.exit(0)}},new Promise(((e,o)=>{var s=e=>{try{n(m.next(e))}catch(e){o(e)}},r=e=>{try{n(m.throw(e))}catch(e){o(e)}},n=o=>o.done?e(o.value):Promise.resolve(o.value).then(s,r);n((m=m.apply(l,a)).next())}));var l,a,m})),e.parse(process.argv);

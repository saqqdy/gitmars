"use strict";var e=(e,t,s)=>new Promise(((n,r)=>{var c=e=>{try{a(s.next(e))}catch(e){r(e)}},i=e=>{try{a(s.throw(e))}catch(e){r(e)}},a=e=>e.done?n(e.value):Promise.resolve(e.value).then(c,i);a((s=s.apply(e,t)).next())}));const t=require("fs"),s=require("shelljs"),n=require("colors"),r=require("./getGitConfig"),c=require("./gitRevParse"),i=require("./getConfig");function a(e){return n.yellow(e)}function o(e){return n.red(e)}function l(e){return n.green(e)}function u(e,t){if(!e||!t)return null;return""+e.replace(/\$\{([a-zA-Z0-9-_]+)\}/g,((e,s)=>{if("function"==typeof t)return t(s);for(const e in t)if(s===e)return t[e]}))}function g(e){const t=String(e).match(/^(\d+)([a-zA-Z]+)$/);let s;if(!t)return null;switch(s=+t[1],t[2]){case"m":s*=60;break;case"h":s*=3600;break;case"d":s*=86400;break;case"w":s*=604800;break;case"M":s*=2592e3;break;case"y":s*=31536e3}return parseInt(String(Date.now()/1e3-s))}function f(e,t){0!==e.length?t(e[0],((s=!1)=>{s||(e.shift(),f(e,t))})):t()}function h(e){return new Promise(((t,n)=>{const r=[];0===e.length&&n("指令名称不能为空"),f(e=JSON.parse(JSON.stringify(e)),((n,c)=>{let i={silent:!0,postmsg:!1,kill:!0,again:!1},u=n;n instanceof Object&&(i=Object.assign(i,n.config||{}),u=n.cmd),u?s.exec(u,i,((t,g,f)=>{const h=$(u);try{g=JSON.parse(g)}catch(e){g=g.replace(/\n*$/g,"")}if(r.push({code:t,out:g,err:f,cfg:i,cmd:u}),0!==t&&m({command:n,code:t,out:g,err:f}),0!==t&&i.kill){const t=JSON.parse(JSON.stringify(e));i.again?!0!==i.again&&t.splice(0,1,i.again):t.shift(),c&&c(!0),p(t),i.silent&&s.echo(o(f)),s.echo(o(i.fail||h.fail||"出错了！指令 "+u+" 执行失败，中断了进程")),i.postmsg&&b("出错了！指令 "+u+" 执行失败，中断了进程"),t.length>0&&s.echo(o("请处理相关问题之后输入gitm continue继续")),s.exit(1)}else{if(0===t){const e=i.success||h.success;e&&(s.echo(l(e)),i.postmsg&&b(e))}else{const e=i.fail||h.fail||"指令 "+u+" 执行失败";e&&s.echo(a(e))}c&&c()}})):t(r)}))}))}function p(e){const{gitDir:t}=c();s.touch(t+"/.gitmarscommands"),s.sed("-i",/[\s\S\n\r\x0a\x0d]*/,encodeURIComponent(JSON.stringify(e)),t+"/.gitmarscommands")}function m(e){const{gitDir:t}=c();s.touch(t+"/.gitmarslog"),s.sed("-i",/[\s\S\n\r\x0a\x0d]*/,encodeURIComponent(JSON.stringify(e)),t+"/.gitmarslog")}function d(e={}){const{silent:t=!0}=e,n=s.exec("git status -s --no-column",{silent:t}).stdout.replace(/(^\s+|\n*$)/g,""),r=n?n.replace(/\n(\s+)/g,"\n").split("\n"):[],c={A:[],D:[],M:[],"??":[]};return 0===r.length||r.forEach((e=>{const t=e.trim().replace(/\s+/g," ").split(" "),s=t.splice(0,1)[0];c[s]||(c[s]=[]),c[s].push(t.join(" "))})),c}function b(e=""){const t=i();if(!t.msgTemplate)return void s.echo(o("请配置消息发送api模板地址"));const n=u(t.msgTemplate,(t=>"message"===t?e:function(e){const{root:t}=c(),{appName:s}=r(),n=i(),a=new Date;let o="";switch(e){case"time":o=a.toLocaleString();break;case"timeNum":o=String(a.getTime());break;case"pwd":o=t;break;case"project":o=s;break;case"user":o=n.user}return o}(t)));t.msgUrl&&n&&k(n)}function k(e="",t={}){const n=i(),{silent:r=!0}=t;n.msgUrl?(e=e.replace(/\s/g,""),n.msgUrl&&s.exec(`curl -i -H "Content-Type: application/json" -X POST -d '{"envParams":{"error_msg":"'${e}'"}}' "${n.msgUrl}"`,{silent:r})):s.echo(o("请配置消息推送地址"))}function $(e){const t={},s=e.replace(/[\s]+/g," ").split(" ");if(s.length<2||"git"!==s[0])return t;switch(s[1]){case"checkout":t.success="切换分支成功",t.fail="切换分支失败";break;case"pull":t.success="拉取代码成功",t.fail="拉取代码失败";break;case"fetch":t.success="抓取成功",t.fail="抓取失败";break;case"commit":t.success="提交成功",t.fail="提交失败";break;case"push":t.success="推送成功",t.fail="推送失败";break;case"cherry-pick":t.success="同步提交记录成功",t.fail="同步提交记录失败";break;case"merge":t.success="merge分支成功",t.fail="merge分支失败";break;case"rebase":t.success="rebase分支成功",t.fail="rebase分支失败";break;case"revert":t.success="撤销成功",t.fail="撤销失败";break;case"clean":t.success="清理成功",t.fail="清理失败"}return t}module.exports={warning:a,error:o,success:l,writeFile:function(e,s){return new Promise(((n,r)=>{t.writeFile(e,s,(e=>{e?r(new Error("文件写入错误")):n(!0)}))}))},mapTemplate:u,getSeconds:g,wait:f,queue:h,getCache:function(){const{gitDir:e}=c();let t=[];return s.test("-f",e+"/.gitmarscommands")&&(t=s.cat(e+"/.gitmarscommands").stdout.split("\n")[0].replace(/(^\n*)|(\n*$)/g,"").replace(/\n{2,}/g,"\n").replace(/\r/g,""),t=JSON.parse(decodeURIComponent(t))),t},setCache:p,setLog:m,getStatusInfo:d,getStatus:function(){const e=d({silent:!1});return e.A.length>0||e.D.length>0||e.M.length>0?(s.echo(o("您还有未提交的文件，请处理后再继续")+"\n如果需要暂存文件请执行: gitm save\n恢复时执行：gitm get"),s.exit(1),!1):(e["??"].length>0&&s.echo(a("您有未加入版本的文件,")+"\n如果需要暂存文件请执行: gitm save --force\n恢复时执行：gitm get"),!0)},getLogs:function(e={}){const{lastet:t,limit:n,branches:r}=e,c=["%H","%T","%P","%an","%ae","%al","%aL","%ad","%ar","%at","%aI","%as","%cn","%ce","%cl","%cL","%cd","%cr","%ct","%cI","%cs","%d","%D","%S","%e","%s"],i=s.exec(`git log${n?' -"'+n+'"':""}${t?' --since="'+g(t)+'"':""}${r?' --branches="*'+r+'"':""} --date-order --pretty=format:"${c.join(",=")}-end-"`,{silent:!0}).stdout.replace(/[\r\n]+/g,"").replace(/-end-$/,""),a=[];return i&&i.split("-end-").forEach((e=>{const t=e.split(",="),s={};c.forEach(((e,n)=>{s[e]=t[n]})),a.push(s)})),a},checkBranch:function(t){return e(this,null,(function*(){return(yield h([`gitm branch -k ${t}`]))[0].out.replace(/^\s+/,"")}))},getCurrent:function(){return s.exec("git symbolic-ref --short -q HEAD",{silent:!0}).stdout.replace(/[\n\s]*$/g,"")},searchBranch:function(t,s,n=!1){return e(this,null,(function*(){const e=(yield h([`gitm branch${t?" -k "+t:""}${s?" -t "+s:""}${n?" -r":""}`]))[0].out.replace(/^\*\s+/,"");let r=e?e.split("\n"):[];return r=r.map((e=>e.trim())),r}))},searchBranchs:function(e={}){const{key:t,type:n,remote:r=!1}=e;let{path:c}=e;c||(c=s.pwd().stdout);const i=s.exec(`git ls-remote${r?" --refs":" --heads"} --quiet --sort="version:refname" ${c}`,{silent:!0}).stdout.replace(/\n*$/g,""),a=i?i.split("\n"):[],o={heads:[],tags:[],others:[]};for(const e of a){const t=e.match(/^\w+[\s]+refs\/(heads|remotes|tags)\/([\w-\/]+)$/);if(t)switch(t[1]){case"heads":case"remotes":o.heads.push(t[2]);break;case"tags":o.tags.push(t[2]);break;default:o.others.push(t[2])}}return n&&["bugfix","feature","support"].includes(n)&&(o.heads=o.heads.filter((e=>e.indexOf("/"+n+"/")>-1))),t&&(o.heads=o.heads.filter((e=>e.indexOf(t)>-1))),o.heads},filterBranch:function(e,t,n=!1){let r,c=[t];"string"==typeof t&&(c=t.split(","));const i=s.exec("git branch"+(n?" -a":""),{silent:!0}).stdout.replace(/(^\s+|[\n\r]*$)/g,"").replace(/\*\s+/,"");return r=i?i.replace(/\n(\s+)/g,"\n").split("\n"):[],r=r.filter((t=>{let s=!0;if(e&&!t.includes(e)&&(s=!1),s&&c.length>0){s=!1;e:for(const e of c)if(t.includes(e)){s=!0;break e}}return s})),r},getStashList:function(t){return e(this,null,(function*(){const e=(yield h(["git stash list"]))[0].out.replace(/^\*\s+/,""),n=e&&e.split("\n")||[],r=[];n.length>10&&s.echo(a(`该项目下一共有${n.length}条暂存记录，建议定期清理！`));try{n.forEach((e=>{const s=e.split(":"),n=s.shift();if(!t||t&&t===s[s.length-1].trim()){const e=n.match(/^stash@\{(\d+)\}$/);s.length>1&&s.shift(),r.push({key:n,index:e?+e[1]:0,msg:s.join(":").trim()})}}))}catch(e){}return r}))},postMessage:b,sendMessage:k,getCommandMessage:$,compareVersion:function(e,t){if(null===e)return null;e+=".",t+=".";const s=parseFloat(e),n=parseFloat(t),r=parseFloat(e.replace(s+".",""))||0,c=parseFloat(t.replace(n+".",""))||0;return!(n>s)&&(n<s||r>=c)},getBranchsFromID:function(e,t=!1){const n=s.exec(`git branch ${t?"-r":""} --contains ${e} --format="%(refname:short)`,{silent:!0}).stdout.replace(/(^\s+|\n*$)/g,"");return n?n.split("\n"):[]},getGitUser:function(){return s.exec("git config user.name",{silent:!0}).stdout.replace(/(^\s+|\n*$)/g,"")},getGitEmail:function(){return s.exec("git config user.email",{silent:!0}).stdout.replace(/(^\s+|\n*$)/g,"")},isGitProject:function(){return s.exec("git rev-parse --is-inside-work-tree",{silent:!0}).stdout.includes("true")}};

#!/usr/bin/env node
"use strict";const{program:e}=require("commander"),i=require("shelljs"),{options:t,args:c}=require("./conf/end"),{error:s,queue:g,getStatus:a,getCurrent:n,searchBranch:o,isGitProject:r}=require("./js/index"),{createArgs:$}=require("./js/tools");r()||(i.echo(s("当前目录不是git项目目录")),i.exit(1));const u=require("./js/getConfig"),f=require("./js/getGitConfig"),l=require("./js/api"),{defaults:p}=require("./js/global"),h=u(),{appName:m}=f();e.name("gitm end").usage("[type] [name]").description("合并bugfix任务分支、合并feature功能开发分支，合并完成后将删除对应分支"),c.length>0&&e.arguments($(c)),t.forEach((i=>{e.option(i.flags,i.description,i.defaultValue)})),e.action((async(e,t,c)=>{const r=["bugfix","feature","support"],$=[p.master,p.develop,p.release,p.bugfix,p.support],{token:u,level:f,nickname:d=""}=h.api?l():{};if(a()||i.exit(1),e){if(!t){r.includes(e)&&(i.echo("请输入分支名称"),i.exit(1));const c=await o(e);1===c.length?[e,t]=c[0].split("/"):(i.echo(c.length>1?`查询到多条名称包含${e}的分支，请输入分支类型`:s("分支不存在，请正确输入")),i.exit(1))}}else[e,t]=n().split("/"),t||($.includes(e)&&i.echo(s(`骚年，你在${e}分支执行这个指令是什么骚操作？`)),i.exit(1));const b=0===i.exec(`git rev-parse --verify origin/${e}/${t}`,{silent:!0}).code;if(r.includes(e)&&t){const i=c.asFeature?h.release:"bugfix"===e?h.bugfix:h.release;let s=[];c.combine&&(s=["git fetch",`git checkout ${h.develop}`,"git pull",{cmd:`git merge --no-ff ${e}/${t}`,config:{again:!1,success:`${e}/${t}合并到${h.develop}成功`,fail:`${e}/${t}合并到${h.develop}出错了，请根据提示处理`}},{cmd:"git push",config:{again:!0,success:"推送成功",fail:"推送失败，请根据提示处理"}},`git checkout ${e}/${t}`]),"support"===e&&(s=s.concat(!f||f<3?["git fetch",`git checkout ${h.bugfix}`,"git pull",{cmd:`git merge --no-ff ${e}/${t}`,config:{again:!1,success:`${e}/${t}合并到${h.bugfix}成功`,fail:`${e}/${t}合并到${h.bugfix}出错了，请根据提示处理`}},{cmd:"git push",config:{again:!0,success:"推送成功",fail:"推送失败，请根据提示处理"}},`git checkout ${e}/${t}`]:[{cmd:`git push --set-upstream origin ${e}/${t}`,config:{again:!0,success:"推送远程并关联远程分支成功",fail:"推送远程失败，请根据提示处理"}},{cmd:`curl -i -H "Content-Type: application/json" -X POST -d "{\\"source_branch\\":\\"${e}/${t}\\",\\"target_branch\\":\\"${h.bugfix}\\",\\"private_token\\":\\"${u}\\",\\"title\\":\\"Merge branch '${e}/${t}' into '${h.bugfix}'\\"}" "${h.gitHost}/api/v4/projects/${h.gitID}/merge_requests"`,config:{again:!0,success:"成功创建合并请求",fail:"创建合并请求出错了，请根据提示处理"}},`gitm postmsg "${d}在${m}项目提交了${e}/${t}分支合并到${h.bugfix}分支的merge请求"`])),c.combine?!f||f<3?(s=s.concat(["git fetch",`git checkout ${i}`,"git pull",{cmd:`git merge --no-ff ${e}/${t}`,config:{again:!1,success:`${e}/${t}合并到${i}成功`,fail:`${e}/${t}合并到${i}出错了，请根据提示处理`}},{cmd:"git push",config:{again:!0,success:"推送成功",fail:"推送失败，请根据提示处理"}},`git checkout ${h.develop}`,`git branch -D ${e}/${t}`]),b&&(s=s.concat([{cmd:`git push origin --delete ${e}/${t}`,config:{again:!0,success:"成功删除远程分支",fail:"删除失败，请联系管理员"}}]))):s=s.concat([{cmd:`git push --set-upstream origin ${e}/${t}`,config:{again:!0,success:"推送远程并关联远程分支成功",fail:"推送远程失败，请根据提示处理"}},{cmd:`curl -i -H "Content-Type: application/json" -X POST -d "{\\"source_branch\\":\\"${e}/${t}\\",\\"target_branch\\":\\"${i}\\",\\"private_token\\":\\"${u}\\",\\"title\\":\\"Merge branch '${e}/${t}' into '${i}'\\"}" "${h.gitHost}/api/v4/projects/${h.gitID}/merge_requests"`,config:{again:!0,success:"成功创建合并请求",fail:"创建合并请求出错了，请根据提示处理"}},`gitm postmsg "${d}在${m}项目提交了${e}/${t}分支合并到${i}分支的merge请求"`]):(s=s.concat([`git checkout ${h.develop}`,`git branch -D ${e}/${t}`]),b&&(s=s.concat([{cmd:`git push origin --delete ${e}/${t}`,config:{again:!0,success:"成功删除远程分支",fail:"删除失败，请联系管理员"}}]))),g(s)}else i.echo(s("type只允许输入："+JSON.stringify(r))),i.exit(1)})),e.parse(process.argv);

#!/usr/bin/env node
"use strict";const{program:e}=require("commander"),t=require("shelljs"),{options:s,args:i}=require("./conf/update"),{error:r,queue:c,getStatus:u,getCurrent:o,filterBranch:a,isGitProject:g}=require("./js/index"),{createArgs:n}=require("./js/tools");g()||(t.echo(r("当前目录不是git项目目录")),t.exit(1));const l=require("./js/getConfig"),{defaults:p}=require("./js/global"),f=l();e.name("gitm update").usage("[type] [name]").description("更新bug任务分支、更新feature功能开发分支、框架调整分支support"),i.length>0&&e.arguments(n(i)),s.forEach((t=>{e.option(t.flags,t.description,t.defaultValue)})),e.action(((e,s,i)=>{const g=["bugfix","feature","support"],n=[p.master,p.develop,p.release,p.bugfix,p.support],l=u();let $=[],d=[];if(l||t.exit(1),i.all)e||(e=g),d=a("",e);else if(e&&s)g.includes(e)?d=[e+"/"+s]:(t.echo(r("type只允许输入："+JSON.stringify(g))),t.exit(1));else{const i=o();[e,s]=i.split("/"),s||(n.includes(e)&&t.echo(r(`骚年，你在${e}分支执行这个指令是什么骚操作？`)),t.exit(1)),g.includes(e)||(t.echo(r("type只允许输入："+JSON.stringify(g))),t.exit(1)),d=[].concat(i)}d.forEach((t=>{[e,s]=t.split("/");const r="bugfix"===e?f.bugfix:"support"===e?f.master:f.release,c=["git fetch",`git checkout ${r}`,"git pull",`git checkout ${e}/${s}`];i.useRebase?c.push({cmd:`git rebase ${r}`,config:{again:!1,success:`${r}更新到${e}/${s}成功`,fail:`${r}更新到${e}/${s}出错了，请根据提示处理`}}):c.push({cmd:`git merge --no-ff ${r}`,config:{again:!1,success:`${r}同步到${e}/${s}成功`,fail:`${r}同步到${e}/${s}出错了，请根据提示处理`}}),$=$.concat(c)})),c($)})),e.parse(process.argv);

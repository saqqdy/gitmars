#!/usr/bin/env node
"use strict";const{program:e}=require("commander"),{spawnSync:r}=require("child_process"),s=require("shelljs"),{options:t,args:o}=require("./conf/upgrade"),{success:i}=require("./js/index"),{createArgs:n}=require("./js/tools"),a=require("ora");e.name("gitm upgrade").usage("[version]").description("升级gitmars"),o.length>0&&e.arguments(n(o)),t.forEach((r=>{e.option(r.flags,r.description,r.defaultValue)})),e.action(((e,t)=>{return o=void 0,n=null,c=function*(){const o=a(i("正在安装请稍后")).start();if(e){const r=e.match(/[0-9.]+$/);r?e=r[0]:["alpha","lite","beta","release","latest","next"].includes(e)||(console.error("输入的版本号不正确"),s.exit(0))}else e="latest";const n=["npm",["install","-g",`gitmars@${e}`]],c=["npm",["uninstall","-g","gitmars"]];t.mirror&&(n[1]=n[1].concat(["-registry","https://registry.npm.taobao.org"])),0!==r(c[0],c[1],{stdio:"inherit",shell:"win32"===process.platform}).status&&(console.warn("卸载出错了"),process.exit(0));const l=r(n[0],n[1],{stdio:"inherit",shell:"win32"===process.platform});r("gitm",["-v"],{stdio:"inherit",shell:"win32"===process.platform}),s.echo(`\n${i("安装完成")}`),o.stop(),0===l.status||console.warn("安装出错了"),process.exit(0)},new Promise(((e,r)=>{var s=e=>{try{i(c.next(e))}catch(e){r(e)}},t=e=>{try{i(c.throw(e))}catch(e){r(e)}},i=r=>r.done?e(r.value):Promise.resolve(r.value).then(s,t);i((c=c.apply(o,n)).next())}));var o,n,c})),e.parse(process.argv);
